@page "/categories"
@using SMIS.UI.Services
@using SMIS.UI.Services.Sync
@using SMIS.Application.DTO.Categories
@using SMIS.UI.Models
@using Syncfusion.Blazor.Grids
@inject CategoryService CategoryService
@inject SyncService SyncService
@inject NavigationManager Navigation

<div class="category-container">
    <div class="page-header">
        <h2>ðŸ“¦ Categories</h2>
        <div class="header-actions">
            <SfButton IconCss="e-icons e-sync" Content="Sync" @onclick="SyncData" CssClass="e-outline"></SfButton>
            <SfButton IconCss="e-icons e-plus" Content="New Category" @onclick="NavigateToCreate" IsPrimary="true"></SfButton>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <SfMessage Severity="MessageSeverity.Error" ShowIcon="true" ShowCloseIcon="true" Closed="@(() => _errorMessage = "")">
            @_errorMessage
        </SfMessage>
    }

    @if (_isLoading)
    {
        <div class="loading-container">
            <SfSpinner></SfSpinner>
        </div>
    }
    else
    {
        <SfCard>
            <CardContent>
                <SfGrid DataSource="@_categories" AllowPaging="true" AllowSorting="true" AllowFiltering="true">
                    <GridPageSettings PageSize="@_pageSize" PageCount="5" CurrentPage="@_currentPage"></GridPageSettings>
                    <GridEvents TValue="CategoryDto" OnActionBegin="@OnGridActionBegin"></GridEvents>
                    <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Menu"></GridFilterSettings>
                    <GridColumns>
                        <GridColumn Field="@nameof(CategoryDto.Name)" HeaderText="Name" Width="150"></GridColumn>
                        <GridColumn Field="@nameof(CategoryDto.Code)" HeaderText="Code" Width="100"></GridColumn>
                        <GridColumn Field="@nameof(CategoryDto.Description)" HeaderText="Description" Width="200"></GridColumn>
                        <GridColumn Field="@nameof(CategoryDto.IsActive)" HeaderText="Active" Width="80" DisplayAsCheckBox="true"></GridColumn>
                        <GridColumn HeaderText="Actions" Width="120">
                            <Template>
                                @{
                                    var category = (context as CategoryDto);
                                    <div class="action-buttons">
                                        <SfButton IconCss="e-icons e-edit" CssClass="e-small e-round" @onclick="() => ShowEditDialog(category)"></SfButton>
                                    </div>
                                }
                            </Template>
                        </GridColumn>
                    </GridColumns>
                </SfGrid>
            </CardContent>
        </SfCard>
    }
</div>

<SfDialog @ref="DialogObj" Width="500px" IsModal="true" ShowCloseIcon="true" @bind-Visible="@_showDialog">
    <DialogTemplates>
        <Header>@(_isEditMode ? "Edit Category" : "New Category")</Header>
        <Content>
            <div class="dialog-content">
                <div class="form-group">
                    <label>Name *</label>
                    <SfTextBox @bind-Value="@_formModel.Name" Placeholder="Enter category name"></SfTextBox>
                </div>
                
                <div class="form-group">
                    <label>Code</label>
                    <SfTextBox @bind-Value="@_formModel.Code" Placeholder="Enter category code"></SfTextBox>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <SfTextBox @bind-Value="@_formModel.Description" Multiline="true" Placeholder="Enter description"></SfTextBox>
                </div>
                
                <div class="form-group">
                    <SfCheckBox @bind-Checked="@_formModel.IsActive" Label="Active"></SfCheckBox>
                </div>
            </div>
        </Content>
        <FooterTemplate>
            <SfButton IsPrimary="true" Content="@(_isEditMode ? "Update" : "Create")" @onclick="SaveCategory"></SfButton>
            <SfButton Content="Cancel" @onclick="CloseDialog" CssClass="e-outline"></SfButton>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

<SfToast @ref="ToastObj" Title="Category" Content="@_toastMessage" ShowCloseButton="true">
    <ToastPosition X="Right" Y="Top"></ToastPosition>
</SfToast>

@code {
    private List<CategoryDto> _categories = new();
    private bool _isLoading = true;
    private bool _showDialog = false;
    private bool _isEditMode = false;
    private string _toastMessage = "";
    private string _errorMessage = "";
    private int _currentPage = PagedList<CategoryDto>.DefaultPageNumber;
    private int _pageSize = PagedList<CategoryDto>.DefaultPageSize;
    private int _totalCount = 0;
    private int _totalPages = 0;
    private SfDialog DialogObj;
    private SfToast ToastObj;
    
    private CategoryFormModel _formModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        _isLoading = true;
        _errorMessage = "";
        
        var result = await CategoryService.GetAllAsync(_currentPage, _pageSize);

        if (result.Success && result.Response != null)
        {
            _categories = result.Response.Items;
            _totalCount = result.Response.TotalCount;
            _totalPages = result.Response.TotalPages;
            _currentPage = result.Response.PageNumber;
            _pageSize = result.Response.PageSize;
        }
        else
        {
            _errorMessage = result.Message ?? "Failed to load categories";
        }

        _isLoading = false;
    }

    private async Task OnGridActionBegin(Syncfusion.Blazor.Grids.ActionEventArgs<CategoryDto> args)
    {
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.Paging)
        {
            _currentPage = (int)args.CurrentPage;
            await LoadCategories();
        }
    }

    private void ShowAddDialog()
    {
        _isEditMode = false;
        _formModel = new CategoryFormModel { IsActive = true, ShopId = "1" };
        _showDialog = true;
    }

    private void ShowEditDialog(CategoryDto category)
    {
        _isEditMode = true;
        _formModel = new CategoryFormModel
        {
            Id = category.Id,
            Name = category.Name,
            Code = category.Code,
            Description = category.Description,
            IsActive = category.IsActive,
            ShopId = category.ShopId
        };
        _showDialog = true;
    }

    private async Task SaveCategory()
    {
        if (string.IsNullOrWhiteSpace(_formModel.Name))
        {
            _toastMessage = "Name is required";
            await ToastObj.ShowAsync();
            return;
        }

        if (_isEditMode)
        {
            var updateDto = new CategoryUpdateDto
            {
                Name = _formModel.Name,
                Code = _formModel.Code,
                Description = _formModel.Description,
                IsActive = _formModel.IsActive
            };
            var result = await CategoryService.UpdateAsync(_formModel.Id, updateDto);
            _toastMessage = result.Success ? "Category updated successfully" : result.Message ?? "Update failed";
        }
        else
        {
            var createDto = new CategoryCreateDto
            {
                Name = _formModel.Name,
                Code = _formModel.Code,
                Description = _formModel.Description,
                IsActive = _formModel.IsActive,
                ShopId = _formModel.ShopId
            };
            var result = await CategoryService.CreateAsync(createDto);
            _toastMessage = result.Success ? "Category created successfully" : result.Message ?? "Create failed";
        }

        await ToastObj.ShowAsync();
        CloseDialog();
        await LoadCategories();
    }

    private void CloseDialog()
    {
        _showDialog = false;
    }

    private async Task SyncData()
    {
        _toastMessage = "Syncing...";
        await ToastObj.ShowAsync();

        var result = await SyncService.SyncCategoriesAsync();
        _toastMessage = result.Message ?? "Sync completed";
        await ToastObj.ShowAsync();

        if (result.Success)
        {
            await LoadCategories();
        }
    }

    private void NavigateToCreate()
    {
        Navigation.NavigateTo("/categories/create");
    }

    private class CategoryFormModel
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string? Code { get; set; }
        public string? Description { get; set; }
        public bool IsActive { get; set; } = true;
        public string ShopId { get; set; } = "";
    }
}

<style>
    .category-container {
        padding: 20px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .page-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 300px;
    }

    .action-buttons {
        display: flex;
        gap: 5px;
    }

    .dialog-content {
        padding: 20px 0;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }
</style>
