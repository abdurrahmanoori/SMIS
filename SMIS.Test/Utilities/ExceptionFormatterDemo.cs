using System;
using System.Net.Http;
using SMIS.Test.Utilities;

namespace SMIS.Test.Utilities
{
    public class ExceptionFormatterDemo
    {
        public static void DemonstrateFormatter()
        {
            // Example of the raw error response from your test
            var rawErrorResponse = @"{
  ""Id"": ""5a154108-3c3d-4d7e-8a45-4bab9b1d4024"",
  ""Message"": ""The instance of entity type \u0027TranslationKey\u0027 cannot be tracked because another instance with the key value \u0027{Id: }\u0027 is already being tracked. When attaching existing entities, ensure that only one entity instance with a given key value is attached."",
  ""StackTrace"": ""   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.IdentityMap\u00601.ThrowIdentityConflict(InternalEntityEntry entry)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.IdentityMap\u00601.Add(TKey key, InternalEntityEntry entry, Boolean updateDuplicate)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.IdentityMap\u00601.Add(TKey key, InternalEntityEntry entry)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.NullableKeyIdentityMap\u00601.Add(InternalEntityEntry entry)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.StartTracking(InternalEntityEntry entry)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetEntityState(EntityState oldState, EntityState newState, Boolean acceptChanges, Boolean modifyProperties)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.InternalEntityEntry.SetEntityStateAsync(EntityState entityState, Boolean acceptChanges, Boolean modifyProperties, Nullable\u00601 forceStateWhenUnknownKey, Nullable\u00601 fallbackState, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.EntityGraphAttacher.PaintActionAsync(EntityEntryGraphNode\u00601 node, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.EntityEntryGraphIterator.TraverseGraphAsync[TState](EntityEntryGraphNode\u00601 node, Func\u00603 handleNode, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.EntityGraphAttacher.AttachGraphAsync(InternalEntityEntry rootEntry, EntityState targetState, EntityState storeGeneratedWithKeySetTargetState, Boolean forceStateWhenUnknownKey, CancellationToken cancellationToken)\r\n   at Microsoft.EntityFrameworkCore.Internal.InternalDbSet\u00601.AddAsync(TEntity entity, CancellationToken cancellationToken)\r\n   at SMIS.Infrastructure.Repositories.Base.GenericRepository\u00601.AddAsync(T entity) in C:\Users\Abdurrahman\source\repos\SMIS\SMIS.Infrastructure\Repositories\Base\GenericRepository.cs:line 33\r\n   at SMIS.Application.Extensions.TranslationKeyUpdateExtensions.AddTranslationKeysForChangedProperties[TDto,TEntity](ITranslationKeyRepository repository, TDto newDto, TEntity existingEntity) in C:\Users\Abdurrahman\source\repos\SMIS\SMIS.Application\Extensions\TranslationKeyUpdateExtensions.cs:line 55\r\n   at SMIS.Application.Features.Categories.Commands.UpdateCategoryCommandHandler.Handle(UpdateCategoryCommand request, CancellationToken cancellationToken) in C:\Users\Abdurrahman\source\repos\SMIS\SMIS.Application\Features\Categories\Commands\UpdateCategoryCommand.cs:line 37\r\n   at SMIS.Application.Common.Behaviors.ValidationPipelineBehavior\u00602.Handle(TRequest request, RequestHandlerDelegate\u00601 next, CancellationToken cancellationToken) in C:\Users\Abdurrahman\source\repos\SMIS\SMIS.Application\Common\Behaviors\ValidationPipelineBehavior.cs:line 56\r\n   at MediatR.Pipeline.RequestExceptionProcessorBehavior\u00602.Handle(TRequest request, RequestHandlerDelegate\u00601 next, CancellationToken cancellationToken)\r\n   at MediatR.Pipeline.RequestExceptionProcessorBehavior\u00602.Handle(TRequest request, RequestHandlerDelegate\u00601 next, CancellationToken cancellationToken)\r\n   at MediatR.Pipeline.RequestExceptionActionProcessorBehavior\u00602.Handle(TRequest request, RequestHandlerDelegate\u00601 next, CancellationToken cancellationToken)\r\n   at MediatR.Pipeline.RequestExceptionActionProcessorBehavior\u00602.Handle(TRequest request, RequestHandlerDelegate\u00601 next, CancellationToken cancellationToken)\r\n   at MediatR.Pipeline.RequestPostProcessorBehavior\u00602.Handle(TRequest request, RequestHandlerDelegate\u00601 next, CancellationToken cancellationToken)\r\n   at MediatR.Pipeline.RequestPreProcessorBehavior\u00602.Handle(TRequest request, RequestHandlerDelegate\u00601 next, CancellationToken cancellationToken)\r\n   at SMIS.Api.Controllers.CategoryController.Update(String id, CategoryCreateDto dto) in C:\Users\Abdurrahman\source\repos\SMIS\SMIS.Api\Controllers\CategoryController.cs:line 32\r\n   at lambda_method482(Closure, Object)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ActionMethodExecutor.AwaitableObjectResultExecutor.Execute(ActionContext actionContext, IActionResultTypeMapper mapper, ObjectMethodExecutor executor, Object controller, Object[] arguments)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.\u003CInvokeActionMethodAsync\u003Eg__Logged|12_1(ControllerActionInvoker invoker)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.\u003CInvokeNextActionFilterAsync\u003Eg__Awaited|10_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Rethrow(ActionExecutedContextSealed context)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Next(State\u0026 next, Scope\u0026 scope, Object\u0026 state, Boolean\u0026 isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.InvokeInnerFilterAsync()\r\n--- End of stack trace from previous location ---\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeFilterPipelineAsync\u003Eg__Awaited|20_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeAsync\u003Eg__Logged|17_1(ResourceInvoker invoker)\r\n   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.\u003CInvokeAsync\u003Eg__Logged|17_1(ResourceInvoker invoker)\r\n   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)\r\n   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)\r\n   at StackExchange.Profiling.MiniProfilerMiddleware.Invoke(HttpContext context) in C:\projects\dotnet\src\MiniProfiler.AspNetCore\MiniProfilerMiddleware.cs:line 94\r\n   at Swashbuckle.AspNetCore.SwaggerUI.SwaggerUIMiddleware.Invoke(HttpContext httpContext)\r\n   at Swashbuckle.AspNetCore.Swagger.SwaggerMiddleware.Invoke(HttpContext httpContext, ISwaggerProvider swaggerProvider)\r\n   at SMIS.Api.Middleware.LogEnrichmentMiddleware.InvokeAsync(HttpContext context) in C:\\Users\\Abdurrahman\\source\\repos\\SMIS\\SMIS.Api\\Middleware\\LogEnrichmentMiddleware.cs:line 28\r\n   at SMIS.Api.Middleware.RequestResponseLoggingMiddleware.InvokeAsync(HttpContext context) in C:\\Users\\Abdurrahman\\source\\repos\\SMIS\\SMIS.Api\\Middleware\\RequestResponseLoggingMiddleware.cs:line 32\r\n   at SMIS.Api.Middleware.ExceptionMiddleware.InvokeAsync(HttpContext context) in C:\\Users\\Abdurrahman\\source\\repos\\SMIS\\SMIS.Api\\Middleware\\ExceptionMiddleware.cs:line 20"",
  ""Source"": ""Microsoft.EntityFrameworkCore"",
  ""InnerException"": null
}";

            Console.WriteLine("BEFORE FORMATTING:");
            Console.WriteLine(rawErrorResponse);
            Console.WriteLine("\n" + new string('=', 80) + "\n");
            
            Console.WriteLine("AFTER FORMATTING:");
            var formatted = ExceptionFormatter.FormatApiResponseError(rawErrorResponse);
            Console.WriteLine(formatted);
        }
    }
}